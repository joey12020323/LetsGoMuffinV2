<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>伺服器活動表</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; padding: 20px; }
    h1 { margin-bottom: 0; }
    #taiwanTime { font-weight: bold; color: darkblue; }
    ul { padding-left: 20px; }
    li { margin-bottom: 4px; }
  </style>
</head>
<body>
  <h1>伺服器活動查詢</h1>
  <p>系統偵測到的台灣時間：<span id="taiwanTime"></span></p>

  <label for="serverSelect">選擇伺服器：</label>
  <select id="serverSelect">
    <option value="37">37服</option>
    <option value="41">41服</option>
  </select>
  <button onclick="loadExcel()">載入資料</button>

  <div id="result" style="margin-top: 20px;"></div>

  <script>
    function updateTaiwanTime() {
      const now = new Date().toLocaleString("zh-TW", { timeZone: "Asia/Taipei" });
      document.getElementById("taiwanTime").textContent = now;
    }

    updateTaiwanTime();
    setInterval(updateTaiwanTime, 1000);

    // ✅ 更新的日期解析：既能解析「M/D」，也能解析「YYYY/M/D」與「YYYY年M月D日」等文字格式
    function parseDate(input, defaultYear) {
      if (input instanceof Date && !isNaN(input)) {
        return new Date(input);
      }

      // 允許傳入數字（極少數情況：Excel 可能給出序列數），這裡不特別處理，維持原有行為
      if (typeof input === 'number' && !isNaN(input)) {
        // 若未來需要，可在此加入 Excel 序列日轉換
        return new Date('Invalid Date');
      }

      const str = String(input).trim();
      // 正規化分隔符與中文字樣：YYYY/M/D、YYYY年M月D日、M/D、M-D 都能處理
      const normalized = str
        .replace(/[年\-]/g, '/')
        .replace(/月/g, '/')
        .replace(/日/g, '')
        .replace(/\s+/g, '');

      const parts = normalized.split('/').filter(Boolean).map(Number);

      if (parts.length === 3) {
        const [y, m, d] = parts;
        return new Date(y, (m || 1) - 1, d || 1);
      } else if (parts.length === 2) {
        const [m, d] = parts;
        return new Date(defaultYear, (m || 1) - 1, d || 1);
      }

      console.warn('無法解析日期格式：', input);
      return new Date('Invalid Date');
    }

    async function loadExcel() {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "<p>載入中...</p>";

      try {
        const response = await fetch("data/schedule.xlsx");
        if (!response.ok) throw new Error("無法讀取 Excel 檔案，HTTP 錯誤碼：" + response.status);
        const arrayBuffer = await response.arrayBuffer();

        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        const server = document.getElementById("serverSelect").value;

        const now = new Date().toLocaleString("en-US", { timeZone: "Asia/Taipei" });
        const currentDate = new Date(now);
        const checkDate = new Date(currentDate);
        checkDate.setDate(currentDate.getDate() - 7); // 🔄 減去七天
        const currentYear = currentDate.getFullYear();

        const filtered = rows.filter(row => {
          if (row.length < 3) return false;
          const dateStr = server === "37" ? row[0] : row[1];
          if (!dateStr) return false;
          const rowDate = parseDate(dateStr, currentYear);
          if (isNaN(rowDate)) return false;
          return rowDate >= checkDate;
        });

        filtered.sort((a, b) => {
          const dateA = parseDate(server === "37" ? a[0] : a[1], currentYear);
          const dateB = parseDate(server === "37" ? b[0] : b[1], currentYear);
          return dateA - dateB;
        });

        if (filtered.length === 0) {
          resultDiv.innerHTML = "<p>沒有符合條件的資料。</p>";
        } else {
          resultDiv.innerHTML = "<h2>活動清單（起始日期 -7天內）：</h2><ul>" +
            filtered.map(row => `<li>${server === "37" ? row[0] : row[1]} - ${row[2]}</li>`).join("") +
            "</ul>";
        }
      } catch (err) {
        console.error("讀取失敗：", err);
        resultDiv.innerHTML = "<p style='color: red;'>讀取失敗：" + err.message + "</p>";
      }
    }
  </script>
</body>
</html>
