<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ä¼ºæœå™¨æ´»å‹•è¡¨</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; padding: 20px; }
    h1 { margin-bottom: 0; }
    #taiwanTime { font-weight: bold; color: darkblue; }
    ul { padding-left: 20px; }
    li { margin-bottom: 4px; }
  </style>
</head>
<body>
  <h1>ä¼ºæœå™¨æ´»å‹•æŸ¥è©¢</h1>
  <p>ç³»çµ±åµæ¸¬åˆ°çš„å°ç£æ™‚é–“ï¼š<span id="taiwanTime"></span></p>

  <label for="serverSelect">é¸æ“‡ä¼ºæœå™¨ï¼š</label>
  <select id="serverSelect">
    <option value="37">37æœ</option>
    <option value="41">41æœ</option>
  </select>
  <button onclick="loadExcel()">è¼‰å…¥è³‡æ–™</button>

  <div id="result" style="margin-top: 20px;"></div>

  <script>
    function updateTaiwanTime() {
      const now = new Date().toLocaleString("zh-TW", { timeZone: "Asia/Taipei" });
      document.getElementById("taiwanTime").textContent = now;
    }

    updateTaiwanTime();
    setInterval(updateTaiwanTime, 1000);

    // âœ… æ›´æ–°çš„æ—¥æœŸè§£æï¼šæ—¢èƒ½è§£æã€ŒM/Dã€ï¼Œä¹Ÿèƒ½è§£æã€ŒYYYY/M/Dã€èˆ‡ã€ŒYYYYå¹´MæœˆDæ—¥ã€ç­‰æ–‡å­—æ ¼å¼
    function parseDate(input, defaultYear) {
      if (input instanceof Date && !isNaN(input)) {
        return new Date(input);
      }

      // å…è¨±å‚³å…¥æ•¸å­—ï¼ˆæ¥µå°‘æ•¸æƒ…æ³ï¼šExcel å¯èƒ½çµ¦å‡ºåºåˆ—æ•¸ï¼‰ï¼Œé€™è£¡ä¸ç‰¹åˆ¥è™•ç†ï¼Œç¶­æŒåŸæœ‰è¡Œç‚º
      if (typeof input === 'number' && !isNaN(input)) {
        // è‹¥æœªä¾†éœ€è¦ï¼Œå¯åœ¨æ­¤åŠ å…¥ Excel åºåˆ—æ—¥è½‰æ›
        return new Date('Invalid Date');
      }

      const str = String(input).trim();
      // æ­£è¦åŒ–åˆ†éš”ç¬¦èˆ‡ä¸­æ–‡å­—æ¨£ï¼šYYYY/M/Dã€YYYYå¹´MæœˆDæ—¥ã€M/Dã€M-D éƒ½èƒ½è™•ç†
      const normalized = str
        .replace(/[å¹´\-]/g, '/')
        .replace(/æœˆ/g, '/')
        .replace(/æ—¥/g, '')
        .replace(/\s+/g, '');

      const parts = normalized.split('/').filter(Boolean).map(Number);

      if (parts.length === 3) {
        const [y, m, d] = parts;
        return new Date(y, (m || 1) - 1, d || 1);
      } else if (parts.length === 2) {
        const [m, d] = parts;
        return new Date(defaultYear, (m || 1) - 1, d || 1);
      }

      console.warn('ç„¡æ³•è§£ææ—¥æœŸæ ¼å¼ï¼š', input);
      return new Date('Invalid Date');
    }

    async function loadExcel() {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "<p>è¼‰å…¥ä¸­...</p>";

      try {
        const response = await fetch("data/schedule.xlsx");
        if (!response.ok) throw new Error("ç„¡æ³•è®€å– Excel æª”æ¡ˆï¼ŒHTTP éŒ¯èª¤ç¢¼ï¼š" + response.status);
        const arrayBuffer = await response.arrayBuffer();

        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        const server = document.getElementById("serverSelect").value;

        const now = new Date().toLocaleString("en-US", { timeZone: "Asia/Taipei" });
        const currentDate = new Date(now);
        const checkDate = new Date(currentDate);
        checkDate.setDate(currentDate.getDate() - 7); // ğŸ”„ æ¸›å»ä¸ƒå¤©
        const currentYear = currentDate.getFullYear();

        const filtered = rows.filter(row => {
          if (row.length < 3) return false;
          const dateStr = server === "37" ? row[0] : row[1];
          if (!dateStr) return false;
          const rowDate = parseDate(dateStr, currentYear);
          if (isNaN(rowDate)) return false;
          return rowDate >= checkDate;
        });

        filtered.sort((a, b) => {
          const dateA = parseDate(server === "37" ? a[0] : a[1], currentYear);
          const dateB = parseDate(server === "37" ? b[0] : b[1], currentYear);
          return dateA - dateB;
        });

        if (filtered.length === 0) {
          resultDiv.innerHTML = "<p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚</p>";
        } else {
          resultDiv.innerHTML = "<h2>æ´»å‹•æ¸…å–®ï¼ˆèµ·å§‹æ—¥æœŸ -7å¤©å…§ï¼‰ï¼š</h2><ul>" +
            filtered.map(row => `<li>${server === "37" ? row[0] : row[1]} - ${row[2]}</li>`).join("") +
            "</ul>";
        }
      } catch (err) {
        console.error("è®€å–å¤±æ•—ï¼š", err);
        resultDiv.innerHTML = "<p style='color: red;'>è®€å–å¤±æ•—ï¼š" + err.message + "</p>";
      }
    }
  </script>
</body>
</html>
